# Security Notes ‚Äî Data Fundamentals Project (E-Learning Platform)
This document provides detailed notes on security setup, RLS, roles, and policies for the E-Learning Platform database project.


## UUID Setup
We switched from integer IDs to UUIDs to align with **Supabase Auth** and ensure globally unique identifiers across the system.

Users Table: The users.id column stores the UUID generated by auth.users upon user sign-up
```sql
ALTER TABLE users
ADD COLUMN user_uuid UUID DEFAULT gen_random_uuid(),
ADD CONSTRAINT users_uuid_unique UNIQUE (user_uuid);

```
Foreign Keys: UUIDs are then linked across tables (e.g., enrollments.student_id, courses.user_id) to replace integer foreign keys.
Based on the structure provided in the uploaded documents for the Data Fundamentals Project (specifically the security notes from the music streaming example and the general project scheme), here are the Security Notes tailored for your E-Learning Platform Database (using the tables: users, courses, and enrollments).


## üîí Row Level Security (RLS)
RLS is enabled on all core tables to enforce the principle of least privilege, restricting what each role (student/admin) can read, insert, update, or delete.
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;

```
üë§ User Policies (Student Role)
The standard student user is restricted to managing only their own data (enrollments) while being able to browse all courses. Policies rely on matching the session's auth.uid() to the user's ID.
```sql
-- Students can read all courses
CREATE POLICY "Users can read all courses"
ON courses FOR SELECT
TO authenticated
USING (TRUE);

-- Students can view their own enrollments
CREATE POLICY "Users can view their own enrollments"
ON enrollments FOR SELECT
TO authenticated
USING (auth.uid() = student_id);

-- Students can insert their own enrollments
CREATE POLICY "Users can insert their own enrollments"
ON enrollments FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = student_id);

-- Students can delete their own enrollments
CREATE POLICY "Users can delete their own enrollments"
ON enrollments FOR DELETE
TO authenticated
USING (auth.uid() = student_id);

```
## üëë Admin Policies
The admin role has full CRUD (Create, Read, Update, Delete) access to all data across all tables. This is achieved by creating an RLS policy that checks if the authenticated user's role, as stored in the users table, is 'admin'.

Admin RLS Policy Template (Applies to ALL tables/actions):
```CREATE POLICY "Admins full access to ALL data"
ON <table_name> FOR ALL -- Applies to SELECT, INSERT, UPDATE, DELETE
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM users WHERE id = auth.uid() AND role = 'admin'
    )
);
```
## üõ†Ô∏è Admin-Only Function (Privileged Access)
A SECURITY DEFINER function is used to execute a privileged, multi-step transaction that requires bypassing RLS. This is vital for complex, sensitive operations like deleting a course.

Purpose: Safely delete a course and all associated enrollments in one atomic operation.

Security: By using SECURITY DEFINER, the function runs with the creator's full privileges, ensuring RLS doesn't block the necessary cascade deletion. The function itself should contain a check to ensure
only 'admin' users can call it.

```sql
CREATE OR REPLACE FUNCTION delete_course_and_enrollments(
    course_id_to_delete uuid
)
RETURNS void 
LANGUAGE plpgsql
SECURITY DEFINER -- Bypasses RLS internally
AS $$
BEGIN
    -- RLS policies are bypassed, but we check user role manually
    IF (SELECT role FROM public.users WHERE id = auth.uid()) != 'admin' THEN
        RAISE EXCEPTION 'Permission denied. Only admins can delete a course and its enrollments.';
    END IF;
    
    -- 1. Delete all student enrollments associated with the course
    DELETE FROM public.enrollments WHERE course_id = course_id_to_delete;
    
    -- 2. Delete the course itself
    DELETE FROM public.courses WHERE course_id = course_id_to_delete;
END;
$$;

```
## üß™ Testing Roles & Policies
Testing ensures policies work as expected for each role.
### User Tests

1.**SELECT** enrollments	Works (Returns only their own enrollments)

2. **INSERT** enrollments (for their own ID)	Works (Successfully enrolls themself)
   
3 .**UPDATE** enrollment	 (No UPDATE policy for students)

4.**DELETE** enrollments (for their own ID)

### Admin Tests
Test Case,Operation,Expected Result

1. **SELECT**all enrollments,SELECT * FROM enrollments,"Works (Returns ALL enrollments, unfiltered)"


2.**UPDATE**courses,UPDATE courses SET title = '...',Works (Admin has full access to update any course)
   
3.**DELETE** a course,SELECT delete_course_and_enrollments(...),Works (Executes privileged function)



